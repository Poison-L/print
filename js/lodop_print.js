var lodopRegister = 1;//lodop是否注册var lodopDomain = 'http://'+window.location.host+'/';var cookieDomain = 'wms.com';//以上信息需预先设定var winW = 0;// 屏幕宽度var winH = 0;// 屏幕高度var LODOP = false;var printers = {};var shipping_method = ["A4"];function setupPrinter() {    $.ajax({        type: "POST",        dataType: "json",        url: "/default/system/setup-printer",        success: function (json) {            if (json.state == '1') {                shipping_method = json.data;                // 增加配货单、下架单自动打印打印机选择                shipping_method.push('PEIHUO_XIAJIA');            }        }    });}function setPrintDialog() {    setupPrinter();    setTimeout(setMainPrintDialog, 500);}function setMainPrintDialog() {    var papers = shipping_method;    // papers.push('A4');    var print_count = LODOP.GET_PRINTER_COUNT();    printers = {};    for (var i = 0; i < print_count; i++) {        printers[i] = LODOP.GET_PRINTER_NAME(i);    }    var html = '<table class="dialog-module" border="0" cellpadding="0" cellspacing="0">';    html += "<tr><th width='100'>纸张</th><th>打印机</th></tr>";    $.each(papers, function (k, v) {        html += "<tr><th>" + v + ":</th><td>";        html += "<select id='" + v + "' class='printer'>";        var paper = $.cookie(v);        for (var b in printers) {            html += "<option value='" + b + "' "                + (paper == b ? "selected" : "") + ">" + printers[b]                + "</option>";        }        html += "</select>";        html += "</td></tr>";    });    html += '</table>';    $('<div title="提示(Tip)" id="dialog-auto-alert-tip">' + html + '</div>').dialog({        autoOpen: true,        width: 500,        _minHeight:80,        height:500,        modal: true,        show: "slide",        buttons: [            {                text: '保存(Save)',                click: function () {                    savePrinter();                    $(this).dialog('close');                }            },            {                text: '取消(Cancel)',                click: function () {                    $(this).dialog("close");                }            }        ],        close: function () {            $(this).detach();        }    });}// 打印机设置function printerSetup() {    try {        LODOP = getLodop(document.getElementById('LODOP_OB'), document.getElementById('LODOP_EM'));        if ((LODOP == null) || (typeof(LODOP.VERSION) == "undefined")) {            alertTip("本机未安装Lodop或需要升级");            return;        }    } catch (err) {        alertTip("本机未安装过Lodop控件");        return;    }    setPrintDialog();}// 保存打印机设置function savePrinter() {    if ($(".printer").size() > 0) {        $(".printer").each(function () {            var paper = this.id;            var val = $(this).val();            // $.cookie(paper, val, {expires: 365, domain: cookieDomain, path: '/'});            $.cookie(paper, val, {expires: 365, path: '/'});        });    }    $.cookie("wmsPrinterOk", "1", {expires: 365, path: '/'});// 打印机设置成功    //alertTip('打印机设置成功');    packOperation(1);    printerShow('');}// 获取打印机function getPrinterName(type) {    if (!LODOP) {        LODOP = getLodop(document.getElementById('LODOP_OB'), document.getElementById('LODOP_EM'));    }    var printerNo = $.cookie(type);    if (printerNo !== null) {        return LODOP.GET_PRINTER_NAME(printerNo);    }    return false;}function getPrinterNo(type) {    return $.cookie(type);}function shipPrint(orderData, OperationCode) {	if(orderData.order.sm_code=='NEUB'){        printUrl('/default/index/print-order/code/'+orderData.order.order_code,'23cm','12.7cm','0','0','NEUB');        return;    }    else if (orderData.order.sm_code=='SGER') {      printUrl('/default/index/print-order/code/'+orderData.order.order_code,'10cm','18cm','0','0','SGER',orderData);      return ;    }	else if (orderData.order.sm_code=='YTO') {      printUrl('/default/index/print-order/code/'+orderData.order.order_code,'10cm','18cm','0','0','YTO',orderData);      return ;    }	else if (orderData.order.sm_code=='CNEXP') {	      printUrl('/default/index/print-order/code/'+orderData.order.order_code,'10cm','15cm','0','0','CNEXP',orderData);	      return ;	    }		else if (orderData.order.sm_code=='ZTO') {		printUrl('/default/index/print-order/code/'+orderData.order.order_code,'10cm','19cm','0','0','ZTO',orderData);	      return ;    }    if (!LODOP) {        LODOP = getLodop(document.getElementById('LODOP_OB'), document.getElementById('LODOP_EM'));    }    var l = -1.5, t = 0;    var printerNo = getPrinterNo(OperationCode);    if (printerNo === null) {        printerSetup();        return;    }    if(!LODOP){        LODOP=getLodop(document.getElementById('LODOP_OB'),document.getElementById('LODOP_EM'));    }    var printerNo = getPrinterNo(orderData.order.sm_code);    LODOP.SET_LICENSES("深圳保宏电子商务综合服务有限公司","AF6A8226CE1786FBF9FF8546C3E7184E","",""); // 再调用一次注册    LODOP.PRINT_INITA("0cm","0","8.48cm","9cm","EZ-WMS");    LODOP.ADD_PRINT_URL("0.2cm","0",'8cm',"8.9cm", lodopDomain+"/default/index/print-Order/code/"+orderData.order.order_code);    LODOP.SET_PRINTER_INDEX(printerNo);    // LODOP.PREVIEW();    LODOP.PRINT();    //统一指向HTML打印/*    $.getScript("/lodop/ship/" + OperationCode + ".js", function (data, textStatus, jqxhr) {        if (jqxhr.status == '200') {            ecPrint(orderData);        }    });*/}function printUrl(url,setWidth,setHeight,left,top,OperationCode,orderData) {    if (!LODOP) {        LODOP = getLodop(document.getElementById('LODOP_OB'), document.getElementById('LODOP_EM'));    }    if(!LODOP){        LODOP=getLodop(document.getElementById('LODOP_OB'),document.getElementById('LODOP_EM'));    }	if(typeof(OperationCode) != "undefined" && OperationCode!=''){		var printerNo = getPrinterNo(OperationCode);	}else{		var printerNo = getPrinterNo('A4');	}    LODOP.SET_LICENSES("深圳保宏电子商务综合服务有限公司","AF6A8226CE1786FBF9FF8546C3E7184E","",""); // 再调用一次注册    LODOP.PRINT_INITA(left,top,setWidth,setHeight,"EZ-WMS");    LODOP.ADD_PRINT_URL(left,top,setWidth,setHeight, lodopDomain+"/"+url);    LODOP.SET_PRINTER_INDEX(printerNo);     if ('undefined' !== typeof orderData) {      switch(orderData.order.sm_code){        case 'SGER':          LODOP.SET_PRINT_PAGESIZE (2, 0, 0, ''); // 横向打印          //LODOP.SET_PRINT_MODE('FULL_WIDTH_FOR_OVERFLOW', true);          //LODOP.SET_PRINT_MODE('FULL_HEIGHT_FOR_OVERFLOW', true);          //LODOP.NewPage();          LODOP.ADD_PRINT_TEXT('9.8cm','18cm',200,20,"QSHK - RA v4");          LODOP.SET_PRINT_STYLEA(0, "ItemType", 0);          LODOP.SET_PRINT_STYLEA(0, "FontSize", 6);          LODOP.SET_PRINT_STYLEA(0, "Italic", 1);          LODOP.SET_PRINT_STYLEA(0,"Angle",90);          if(orderData.order.tracking_number){            LODOP.ADD_PRINT_BARCODE('8.2cm','8.8cm','180','40','128A',orderData.order.tracking_number);          }          break;		case 'YTO':			LODOP.SET_PRINT_PAGESIZE (1, 1000, 1800, '');			LODOP.SET_PRINT_STYLEA(0, "Italic", 1);			LODOP.ADD_PRINT_BARCODE("4.4cm","3cm",'180','40','128A',orderData.order.tracking_number);			LODOP.ADD_PRINT_BARCODE("11.4cm","4.6cm",'180','40','128A',orderData.order.tracking_number);						LODOP.SET_PRINT_STYLEA(0,"Angle",0);			//LODOP.SET_PRINT_STYLEA(0,"ShowBarText",0);						LODOP.SET_PRINT_PAGESIZE (1, 1000, 1800, '');			LODOP.SET_PRINT_STYLEA(0, "Italic", 1);			LODOP.ADD_PRINT_BARCODE("0.6cm","6cm",'120','40','128A',orderData.address.oab_transfercentercode);			LODOP.SET_PRINT_STYLEA(0,"Angle",0);			//LODOP.SET_PRINT_STYLEA(0,"ShowBarText",0);			break;		case 'CNEXP':			LODOP.SET_PRINT_PAGESIZE (1, 1000, 1500, '');			LODOP.SET_PRINT_STYLEA(0, "Italic", 1);			LODOP.ADD_PRINT_BARCODE("0.7cm","4.5cm",'180','50','128A',orderData.order.tracking_number);			LODOP.ADD_PRINT_BARCODE(345,10,'180','50','128A',orderData.order.tracking_number);						LODOP.SET_PRINT_STYLE("FontSize",26);		//设置打印项的输出风格，成功执行该函数，此后再增加的打印项按此风格输出。			LODOP.SET_PRINT_STYLE("Bold",1);			LODOP.ADD_PRINT_TEXT(20,17,500,100,"国内小包");		//ADD_PRINT_TEXT(Top,Left,Width,Height,strContent)	要求在打印初始化后调用，建议在画线类函数之后调用。									LODOP.SET_PRINT_STYLE("FontSize",12);		//设置打印项的输出风格，成功执行该函数，此后再增加的打印项按此风格输出。			LODOP.SET_PRINT_STYLE("Bold",1);			LODOP.ADD_PRINT_TEXT(92,5,1400,40,"广州  转");				LODOP.ADD_PRINT_TEXT(92,270,1400,40,"投递局");				LODOP.ADD_PRINT_TEXT(92,105,80,40,orderData.address.oab_city);				//LODOP.ADD_PRINT_TEXT(92,300,80,40,投递局);							LODOP.SET_PRINT_STYLE("FontSize",10);		//设置打印项的输出风格，成功执行该函数，此后再增加的打印项按此风格输出。			LODOP.SET_PRINT_STYLE("Bold",1);			LODOP.ADD_PRINT_TEXT(150,5,20,100,"收件");										//收件人详情			LODOP.SET_PRINT_STYLE("FontSize",10);			LODOP.SET_PRINT_STYLE("FontName","宋体");			LODOP.SET_PRINT_STYLE("Bold",1);			LODOP.ADD_PRINT_TEXT(125,35,1500,100,orderData.address.oab_lastname+orderData.address.oab_firstname);				LODOP.ADD_PRINT_TEXT(125,90,1500,100,orderData.address.oab_phone);				LODOP.ADD_PRINT_TEXT(125,210,1500,100,orderData.address.oab_postcode);				LODOP.ADD_PRINT_TEXT(150,35,1500,100,orderData.address.oab_state+orderData.address.oab_city+orderData.address.oab_street_address1);							//收件人下面竖线			LODOP.ADD_PRINT_LINE(220,185,330,185,1,5);						//订单号			LODOP.SET_PRINT_STYLE("FontSize",8);			LODOP.SET_PRINT_STYLE("FontName","宋体");			LODOP.ADD_PRINT_TEXT(230,10,180,200,"订单号:"+orderData.order.order_code);				//LODOP.ADD_PRINT_TEXT(250,10,180,200,"品名:"+orderData.order.parcel_contents);				LODOP.ADD_PRINT_TEXT(310,10,180,200,"重量:(克)"+orderData.order.grossWt*1000);							//收件人			LODOP.SET_PRINT_STYLE("FontSize",9);			LODOP.SET_PRINT_STYLE("Bold",1);			LODOP.SET_PRINT_STYLE("FontName","宋体");			LODOP.ADD_PRINT_TEXT(230,195,180,200,"收件人/代收人:");				LODOP.ADD_PRINT_TEXT(280,195,180,200,"代收款:");				LODOP.ADD_PRINT_TEXT(295,195,180,200,"签收时间:");				LODOP.ADD_PRINT_TEXT(310,260,180,200,"年  月  日  时");									//邮政logo						LODOP.ADD_PRINT_IMAGE(347,195,140,60,"<img width='140px' height='60px' src='/images/print/CNEXP.png' />")						//收件人			LODOP.ADD_PRINT_LINE(405,0,405,1400,1,5);			LODOP.SET_PRINT_STYLE("FontSize",10);		//设置打印项的输出风格，成功执行该函数，此后再增加的打印项按此风格输出。			LODOP.SET_PRINT_STYLE("Bold",1);			LODOP.ADD_PRINT_TEXT(410,5,20,100,"收件");				//收件人详情			LODOP.SET_PRINT_STYLE("FontSize",10);			LODOP.SET_PRINT_STYLE("FontName","宋体");			LODOP.SET_PRINT_STYLE("Bold",1);			LODOP.ADD_PRINT_TEXT(410,35,1500,100,orderData.address.oab_lastname+orderData.address.oab_firstname);				LODOP.ADD_PRINT_TEXT(410,90,1500,100,orderData.address.oab_phone);				LODOP.ADD_PRINT_TEXT(410,210,1500,100,orderData.address.oab_postcode);				LODOP.ADD_PRINT_TEXT(425,35,1500,100,orderData.address.oab_state+orderData.address.oab_city+orderData.address.oab_street_address1);																//寄件人			LODOP.ADD_PRINT_LINE(470,0,470,1400,1,5);						LODOP.SET_PRINT_STYLE("FontSize",10);		//设置打印项的输出风格，成功执行该函数，此后再增加的打印项按此风格输出。			LODOP.SET_PRINT_STYLE("Bold",1);			LODOP.ADD_PRINT_TEXT(473,5,20,100,"寄件");							LODOP.ADD_PRINT_LINE(405,30,524,30,1,5);//竖线			LODOP.ADD_PRINT_LINE(470,310,550,310,1,5);//竖线			LODOP.SET_PRINT_STYLE("FontSize",8);			LODOP.SET_PRINT_STYLE("FontName","宋体");			LODOP.ADD_PRINT_TEXT(475,35,1500,100,orderData.address.shipper_address);				LODOP.ADD_PRINT_TEXT(485,35,1500,100,orderData.address.shipper_telephone);				LODOP.ADD_PRINT_TEXT(495,35,1500,100,"客户编码:222333	(收寄局)");										LODOP.ADD_PRINT_LINE(524,0,524,310,1,5);	//横线			//订单号			LODOP.SET_PRINT_STYLE("FontSize",8);			LODOP.SET_PRINT_STYLE("FontName","宋体");			LODOP.ADD_PRINT_TEXT(526,10,180,200,"订单号:"+orderData.order.order_code);				LODOP.ADD_PRINT_LINE(540,0,540,310,1,5);	//横线			//订单号			LODOP.SET_PRINT_STYLE("FontSize",8);			LODOP.SET_PRINT_STYLE("FontName","宋体");			LODOP.ADD_PRINT_TEXT(542,10,310,200,"网址:www.chinapost.com.cn");										//添加线条			LODOP.ADD_PRINT_LINE(90,0,90,1400,1,5);			LODOP.ADD_PRINT_LINE(120,0,120,1400,1,5);						//竖线			LODOP.ADD_PRINT_LINE(120,30,220,30,1,5);						//横线			LODOP.ADD_PRINT_LINE(220,0,220,1400,1,5);			//LODOP.SET_PRINT_STYLEA(0,"ShowBarText",0);			break;		case 'ZTO':			LODOP.SET_PRINT_PAGESIZE (1, 1000, 1900, '');			LODOP.SET_PRINT_STYLEA(0, "Italic", 1);			LODOP.ADD_PRINT_BARCODE("1.8cm","1.8cm",'170','50','128B',orderData.order.tracking_number);			//LODOP.SET_PRINT_STYLEA(0,"ShowBarText",0);							//中通logo			LODOP.ADD_PRINT_IMAGE(400,0,150,34,"<img width='150px' height='34px' src='/images/print/zto.png' />")			LODOP.ADD_PRINT_BARCODE("10.6cm","4.2cm",'150','50','128B',orderData.order.tracking_number);			LODOP.SET_PRINT_STYLEA(0,"Angle",0);			//LODOP.SET_PRINT_STYLEA(0,"ShowBarText",0);			        default:          break;      }    }    //LODOP.PREVIEW();    LODOP.PRINT();}// 自动打印配货单、下架单function printPeihuoXiajia(url, title) {  if (!LODOP) {    LODOP = getLodop(document.getElementById('LODOP_OB'), document.getElementById('LODOP_EM'));  }  var printerNo = getPrinterNo('PEIHUO_XIAJIA');  var title = title ? title : '配货下架单';  // 还未设置打印机？  if (isNaN(parseInt(printerNo))) {    printerSetup();    return ;  }  LODOP.SET_LICENSES("深圳保宏电子商务综合服务有限公司","AF6A8226CE1786FBF9FF8546C3E7184E","",""); // 再调用一次注册  LODOP.PRINT_INITA(0, 0, '21cm', '29.7cm', title);  LODOP.ADD_PRINT_URL(0, 0, '21cm', '29.7cm', lodopDomain + '/' + url);  LODOP.SET_PRINTER_INDEX(printerNo);  //LODOP.PREVIEW();  LODOP.PRINT();}function initSet() {    if ($.cookie('wmsPrinterOk') != 1 || $.cookie('wmsPrinterOk') == null) {        packOperation(0);        printerSetup();//打印机设置    }    if ($.cookie('wmsPrinterOk') != 1 && (LODOP != null) && (typeof(LODOP.VERSION) != "undefined") && !$("#dialog-auto-alert-tip").dialog('isOpen')) {        packOperation(0);        setPrintDialog();    }}function packOperation(s) {    if (s == '1') {        $("#pack-operation-area").show();        if ($("#pickingCode", "#searchForm")) {            $("#pickingCode", "#searchForm").focus().select();        }        if ($("#orderCode", "#searchForm")) {            $("#orderCode", "#searchForm").focus().select();            return false;        }    } else {        printerShow('您还没有设置打印机,请设置!');        $("#pack-operation-area").hide();    }}function printerShow(html) {    $("#printSet-tip").html(html);}//重新打印function getOrdersReprint(code) {    $.ajax({        type: "post",        async: false,        dataType: "json",        url: "/shipment/orders-one-pack/get-order-info",        data:{            orderCode:code        },        success: function (json) {            var html = '';            if (isJson(json)) {                if(json.state=='1'){                    shipPrint(json.data,json.data.order.sm_code);                }else{                    alertTip(json.message);                }            }        }});}$(function () {    winW = window.screen.availWidth;// 初始化    winH = window.screen.availHeight;// 初始化    setTimeout(initSet, 50);});